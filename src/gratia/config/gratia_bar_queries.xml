<graphtool-config>

  <import module="gratia.config" data_file="generic_queries.xml" />
  <import module="gratia.config" data_file="vo_ownership_queries.xml"/>

  <class type="SqlQueries" name="GratiaBarQueries">

    <attribute name="display_name"> Bar Graphs </attribute>
    <attribute name="connection_manager"> GratiaConnMan </attribute>

    <query name="vo_hours_bar_smry" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
      <attribute name="pivot_name"> VO </attribute>
      <attribute name="title"> Hours Spent on Jobs By VO </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="graph_type"> GratiaStackedBar </attribute>
    </query>

    <query name="osg_wall_hours" base="GratiaGenericQuery.jobs_summary_query">
        <inputs>
            <input name="span" type="eval" kind="sql">7*86400</input>
            <input name="starttime" type="datetime" kind="sql">time.time()-7*86400*52</input>
            <input name="endtime" type="datetime" kind="sql">time.time()</input>
        </inputs>
        <sql>
            <filler name="group"> R.VOName </filler>
            <filler name="column"> sum(WallDuration)/3600 </filler>
            <filler name="where"> AND WallDuration > 0 </filler>
        </sql>
        <attribute name="title"> Computation Hours Per Week </attribute>
        <attribute name="pivot_name"> VO </attribute>
        <attribute name="column_names"> Computation Time </attribute>
        <attribute name="column_units"> Hours </attribute>
        <attribute name="graph_type"> GratiaStackedBar </attribute>
    </query>

    <query name="facility_hours_bar_smry" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">Hours Spent on Jobs By Facility</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

    <query name="facility_cpu_hours_bar_smry" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(CpuUserDuration + CpuSystemDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">CPU Hours Spent on Jobs By Facility</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

    <query name="facility_cpu_efficiency" base="GratiaGenericQuery.jobs_summary_query">
      <inputs>
          <input name="facility" kind="sql">Nebraska</input>
      </inputs>
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(CpuUserDuration + CpuSystemDuration)/sum(WallDuration) </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">CPU Efficiency for $facility</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

    <query name="vo_efficiency_summary" base="GratiaGenericQuery.simple_summary">
      <inputs>
          <input name="vo" kind="sql">dzero</input>
      </inputs>
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(CpuUserDuration + CpuSystemDuration)/sum(WallDuration) </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">CPU Efficiency</attribute>
      <attribute name="graph_type">QualityBarGraph</attribute>
    </query>

    <query name="vo_cpu_efficiency" base="GratiaGenericQuery.jobs_summary_query">
      <inputs>
          <input name="vo" kind="sql">cms</input>
      </inputs>
      <sql>
        <filler name="group"> R.VOName </filler>
        <filler name="column"> sum(CpuUserDuration + CpuSystemDuration)/sum(WallDuration) </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">VO</attribute>
      <attribute name="title">CPU Efficiency for $vo</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

    <query name="probe_hours_bar_smry" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.ProbeName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">Hours Spent on Jobs By Probe</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

    <query name="vo_facility_hours_bar_smry" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">$vo CPU Hours By Facility</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results>
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

    <query name="vo_opp_hours_bar" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">$vo CPU Hours By Facility</attribute>
      <attribute name="graph_type">GratiaOpp</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser">
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>

<!--
    <query name="facility_quality" base="GratiaGenericQuery.jobs_summary_query">
        <sql>
            <filler name="group"> S.SiteName </filler>
            <filler name="column"> 
                sum(CASE StatusCode WHEN 0 THEN 1 ELSE 0 END) as Successes,
                sum(CASE StatusCode WHEN 0 THEN 0 ELSE 1 END) as Failures
            </filler>
        </sql>
        <results>
            <inputs>
                <input name="grouping_transform">make_int</input>
                <input name="results"> 2, 3 </input>
            </inputs>
        </results>
        <attribute name="graph_type"> QualityMap </attribute>
        <attribute name="fixed-height"> False </attribute>
        <attribute name="title"> Job Quality by Facility </attribute>
        <attribute name="column_names"> Successful, Failed</attribute>
        <attribute name="column_units"> Jobs, Jobs </attribute>
        <attribute name="pivot_name">Facility</attribute>
    </query>
-->

    <query name="vo_opp_hours_bar2" base="GratiaGenericQuery.jobs_summary_query">
      <sql> 
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Facility</attribute>
      <attribute name="title">CPU Hours by Usage Type</attribute>
      <attribute name="graph_type">GratiaOpp</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser2">
        <inputs>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
    </query>
       
    <query name="facility_opp_bar" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">CPU Hours by Usage Type</attribute>
      <attribute name="graph_type">GratiaOpp</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser3">
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_opp" base="GratiaGenericQuery.jobs_summary_query">
      <inputs>
          <input name="exclude-facility" kind="sql">None</input>
      </inputs>
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Opportunistic CPU Hours</attribute>
      <attribute name="graph_type">GratiaOpp</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser4">
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_vos" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Opportunistic CPU Hours by VO</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser5">
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_sites" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Opportunistic CPU Hours by Site</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser_sites">
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_vos_perc" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Percent of Total Opportunistic CPU Hours by VO</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser_vos_perc">
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_sites_perc" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Percent of Total Opportunistic CPU Hours by Site</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser_sites_perc">
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_perc" base="GratiaGenericQuery.jobs_summary_query">
      <sql> 
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Percent of Opportunistic CPU Hours</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_parser_perc"> 
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_perc_vos" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">VO Percent of Opportunistic CPU Hours</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="column_names">Owned,Opportunistic</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_perc_vos"> 
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="osg_sharing_perc_sites" base="GratiaGenericQuery.jobs_summary_query">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Site Percent of Opportunistic CPU Hours</attribute>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="column_names">Owned,Opportunistic</attribute>
      <results module="gratia.database.query_handler" function="opportunistic_usage_perc_sites"> 
        <inputs>
          <input name="grouping_transform">make_int</input>
          <input name="pivots"> 0,1 </input>
          <input name="grouping"> 2 </input>
          <input name="results"> 3 </input>
        </inputs>
      </results>
    </query>

    <query name="exitcode_bar">
        <inputs>
            <input name="span" kind="sql" type="int">604800</input>
            <input name="starttime" type="datetime" kind="sql">time.time()-365*86400</input>
            <input name="endtime" type="datetime" kind="sql">time.time()</input>
            <input name="vo" kind="sql"> .* </input>
        </inputs>
        <sql>
            select 
             unix_timestamp(STR_TO_DATE(concat(Week,' Monday'), '%%x-%%v %%W')),
             ExitCode,
             sum(Njobs)
            from VOJobStatusSummary VS
            join VONameCorrection VC on (VS.VOcorrid = VC.corrid)
            join VO on (VC.void = VO.void)
            where
             STR_TO_DATE(concat(Week,' Monday'), '%%x-%%v %%W') &gt; :starttime AND
             STR_TO_DATE(concat(Week,' Monday'), '%%x-%%v %%W') &lt;= :endtime AND
             VO.VOName regexp :vo
            group by
             STR_TO_DATE(concat(Week,' Monday'), '%%x-%%v %%W'),
             ExitCode
        </sql>
        <results module="graphtool.database.query_handler" function="results_parser">
            <inputs>
                <input name="pivots"> 1 </input>
                <input name="grouping"> 0 </input>
                <input name="results"> 2 </input>
            </inputs>
        </results>
        <attribute name="pivot_name">Exit Code</attribute>
        <attribute name="grouping_name">Time</attribute>
        <attribute name="title">Exit Code Count for $vo</attribute>
        <attribute name="column_names">Exit Code Count</attribute>
        <attribute name="column_units">Jobs</attribute>
        <attribute name="graph_type">GratiaStackedBar</attribute>
    </query>

    <!-- Grid-wide queries -->
    <query name="user_transfer_volume" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> DN </filler>
            <filler name="column"> sum(BytesTransferred)/pow(1024, 3)</filler>
        </sql>
        <results>
            <inputs>
                <input name="pivot_transform">displayName</input>
            </inputs>
        </results>
        <attribute name="pivot_name">Facility</attribute>
        <attribute name="title">Volume of Gigabytes Transferred By User</attribute>
        <attribute name="column_names">Transfer Volume</attribute>
        <attribute name="column_units">GB</attribute>
    </query>

    <query name="facility_transfer_volume" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> SiteName </filler>
            <filler name="column"> sum(BytesTransferred)/pow(1024, 3)</filler>
        </sql>
        <attribute name="pivot_name">Facility</attribute>
        <attribute name="title">Volume of Gigabytes Transferred By Facility</attribute>
        <attribute name="column_names">Transfer Volume</attribute>
        <attribute name="column_units">GB</attribute>
    </query>

    <query name="facility_transfer_rate" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> SiteName </filler>
            <filler name="column"> sum(BytesTransferred)/pow(1024, 2)/:span</filler>
        </sql>
        <attribute name="pivot_name">Facility</attribute>
        <attribute name="title">Transfer Rate By Facility</attribute>
        <attribute name="column_names">Transfer Rate</attribute>
        <attribute name="column_units">MB/s</attribute>
    </query>

    <query name="vo_transfer_volume" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> VO </filler>
            <filler name="column"> sum(BytesTransferred)/pow(1024, 3)</filler>
        </sql>
        <attribute name="pivot_name">VO</attribute>
        <attribute name="title">Volume of Gigabytes Transferred By VO</attribute>
        <attribute name="column_names">Transfer Volume</attribute>
        <attribute name="column_units">GB</attribute>
    </query>

    <query name="vo_transfer_rate" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> VO </filler>
            <filler name="column"> sum(BytesTransferred)/pow(1024, 2)/:span</filler>
        </sql>
        <attribute name="pivot_name">VO</attribute>
        <attribute name="title">Transfer Rate By VO</attribute>
        <attribute name="column_names">Transfer Rate</attribute>
        <attribute name="column_units">MB/s</attribute>
    </query>

    <query name="facility_quality" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> SiteName </filler>
            <filler name="column"> 
                sum(CASE StatusCode WHEN 0 THEN 1 ELSE 0 END) as Successes,
                sum(CASE StatusCode WHEN 0 THEN 0 ELSE 1 END) as Failures
            </filler>
        </sql>
        <results>
            <inputs>
                <input name="results"> 2, 3 </input>
            </inputs>
        </results>
        <attribute name="graph_type"> QualityMap </attribute>
        <attribute name="fixed-height"> False </attribute>
        <attribute name="title"> Transfer Quality by Facility </attribute>
        <attribute name="column_names"> Successful Transfers, Failed Transfers </attribute>
        <attribute name="column_units"> Files, Files </attribute>
        <attribute name="pivot_name">Facility</attribute>
    </query>

    <query name="vo_quality" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> VO </filler>
            <filler name="column">
                sum(CASE StatusCode WHEN 0 THEN 1 ELSE 0 END) as Successes,
                sum(CASE StatusCode WHEN 0 THEN 0 ELSE 1 END) as Failures
            </filler>
        </sql>
        <results>
            <inputs>
                <input name="results"> 2, 3 </input>
            </inputs>
        </results>
        <attribute name="graph_type"> QualityMap </attribute>
        <attribute name="fixed-height"> False </attribute>
        <attribute name="title"> Transfer Quality by VO </attribute>
        <attribute name="column_names"> Successful Transfers, Failed Transfers </attribute>
        <attribute name="column_units"> Files, Files </attribute>
    </query>

    <query name="user_quality" base="GratiaStorageQuery.summary">
        <sql>
            <filler name="group"> DN </filler>
            <filler name="column">
                sum(CASE StatusCode WHEN 0 THEN 1 ELSE 0 END) as Successes,
                sum(CASE StatusCode WHEN 0 THEN 0 ELSE 1 END) as Failures
            </filler>
        </sql>
        <results>
            <inputs>
                <input name="pivot_transform">displayName</input>
                <input name="results"> 2, 3 </input>
            </inputs>
        </results>
        <attribute name="graph_type"> QualityMap </attribute>
        <attribute name="fixed-height"> False </attribute>
        <attribute name="title"> Transfer Quality by User </attribute>
        <attribute name="column_names"> Successful Transfers, Failed Transfers </attribute>
        <attribute name="column_units"> Files, Files </attribute>
    </query>

    <!-- VO queries -->

    <!-- Site queries -->

    <query name="site_user_quality" base="GratiaStorageQuery.site_summary">
        <sql>
            <filler name="group"> DN </filler>
            <filler name="column">
                sum(CASE StatusCode WHEN 0 THEN 1 ELSE 0 END) as Successes,
                sum(CASE StatusCode WHEN 0 THEN 0 ELSE 1 END) as Failures
            </filler>
        </sql>  
        <results>
            <inputs>
                <input name="pivot_transform">displayName</input>
                <input name="results"> 2, 3 </input>
            </inputs>
        </results>
        <attribute name="graph_type"> QualityMap </attribute>
        <attribute name="fixed-height"> False </attribute>
        <attribute name="title"> Site Quality by User </attribute>
        <attribute name="column_names"> Successful Transfers, Failed Transfers </attribute>
        <attribute name="column_units"> Files, Files </attribute>
    </query>

    <!-- User queries -->

  </class>

</graphtool-config>
