<graphtool-config>

  <import module="gratia.database.query_handler">*</import>

  <import module="graphtool.database.queries">SqlQueries</import>
  <import module="graphtool.database.query_handler">*</import>
  <import module="time"/> 
  <import file="$DBPARAM_LOCATION" />
 
  <class type="SqlQueries" name="GratiaGenericQuery">

    <attribute name="connection_manager"> GratiaConnMan </attribute>

    <aggregate>
      <connection> gratia </connection>
    </aggregate>

    <query name="simple_query">
      <inputs>
        <input name="span" type="int" kind="sql">3600</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-2*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
      </inputs>
      <sql>
        SELECT
          <slot name="group"/>,
          <slot name="column"/>
        FROM
          JobUsageSimple
        JOIN
          CEProbes ON JobUsageSimple.ProbeName = CEProbes.probename
        JOIN
          CETable ON CEProbes.facility_id = CETable.facility_id
        <slot name="JOIN"/>
        WHERE
          EndTime &gt;= :starttime AND
          EndTime &lt; :endtime AND
          CETable.facility_name regexp :facility AND
          ReportableVOName regexp :vo 
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>
        <slot name="having"/> 
      </sql>
      <results module="graphtool.database.query_handler" function="simple_results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="results"> 1 </input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaPie</attribute>
      <attribute name="pivot_name" />
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="simple_master_summary">
        <inputs>
            <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
            <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
            <input name="includeFailed" kind="sql"> true </input>
            <input name="includeSuccess" kind="sql"> true </input>
            <input name="facility" kind="sql"> .* </input>
            <input name="probe" kind="sql"> .* </input>
            <input name="user" kind="sql"> .* </input>
            <input name="vo" kind="sql"> .* </input>
            <input name="role" kind="sql"> .* </input>
            <input name="exclude-role" kind="sql"> NONE </input>
            <input name="exclude-vo" kind="sql"> unknown|other </input>
            <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
            <input name="exclude-user" kind="sql"> NONE </input>
            <input name="resource-type" kind="sql"> ^Batch$ </input>
        </inputs>
        <sql>
            SELECT
                <slot name="group"/>,
                <slot name="column"/>
            FROM
                MasterSummaryData R
            JOIN
                Probe P on R.ProbeName = P.probename
            JOIN
                Site S on S.siteid = P.siteid
            JOIN
                VONameCorrection VC ON (VC.corrid=R.VOcorrid)
            JOIN
                VO on (VC.void = VO.void)
            <slot name="join"/>
            WHERE
                R.EndTime &gt;= :starttime AND
                R.EndTime &lt; :endtime AND
                S.SiteName regexp :facility AND
                VO.VOName regexp :vo AND
                VC.VOName regexp :role AND
                (NOT (VC.VOName regexp :exclude-role)) AND
                (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
                (:includeFailed='true' OR ApplicationExitCode=0) AND
                (:includeSuccess ='true' OR ApplicationExitCode!=0) AND
                (NOT (S.SiteName regexp :exclude-facility)) AND
                (NOT (VO.VOName regexp :exclude-vo)) AND
                R.WallDuration &lt; 1100000000 AND
                R.ProbeName regexp :probe AND
                (NOT (R.CommonName regexp :exclude-user)) AND
                R.CommonName regexp :user
                <slot name="where"/>
            GROUP BY 
                <slot name="group"/>
            <slot name="having"/>
        </sql>
        <results module="graphtool.database.query_handler" function="simple_results_parser">
            <inputs>
                <input name="pivots"> 0 </input>
                <input name="results"> 1 </input>
            </inputs>
        </results>
        <attribute name="graph_type">GratiaPie</attribute>
        <attribute name="pivot_name" />
        <attribute name="title" />
        <attribute name="column_names" />
        <attribute name="column_units" />
    </query>
    
    <query name="simple_glidein_master_summary">
        <inputs>
            <input name="span" type="int" kind="sql">86400</input>
            <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-14*86400</input>
            <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
            <input name="includeFailed" kind="sql"> true </input>
            <input name="includeSuccess" kind="sql"> true </input>
            <input name="facility" kind="sql"> .* </input>
            <input name="probe" kind="sql"> .* </input>
            <input name="user" kind="sql"> .* </input>
            <input name="vo" kind="sql"> .* </input>
            <input name="role" kind="sql"> .* </input>
            <input name="exclude-role" kind="sql"> NONE </input>
            <input name="exclude-vo" kind="sql"> unknown|other </input>
            <input name="exclude-user" kind="sql"> NONE </input>
            <input name="exclude-facility" kind="sql"> NONE  </input>
            <input name="resource-type" kind="sql"> BatchPilot </input>
            <input name="grid" kind="sql"> .* </input>
        </inputs>
        <sql>
            SELECT
                <slot name="group"/>,
                <slot name="column"/>
            FROM
                MasterSummaryData R
            JOIN
                Probe P on R.ProbeName = P.probename
            JOIN
                Site S on S.siteid = P.siteid
            JOIN
                VONameCorrection VC ON (VC.corrid=R.VOcorrid)
            JOIN
                VO on (VC.void = VO.void)
            <slot name="join"/> 
            WHERE
                R.EndTime &gt;= :starttime AND
                R.EndTime &lt; :endtime AND
                R.HostDescription regexp :facility AND
                R.Grid regexp :grid AND
                VO.VOName regexp :vo AND
                VC.VOName regexp :role AND
                (NOT (VC.VOName regexp :exclude-role)) AND
                (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
                R.CommonName regexp :user AND
                (:includeFailed='true' OR ApplicationExitCode=0) AND
                (:includeSuccess ='true' OR ApplicationExitCode!=0) AND
                (NOT (S.SiteName regexp :exclude-facility)) AND
                (NOT (R.CommonName regexp :exclude-user)) AND
                (NOT (VO.VOName regexp :exclude-vo)) AND
                R.WallDuration &lt; 1100000000 AND
                R.ProbeName regexp :probe
                <slot name="where"/>
            GROUP BY 
                <slot name="group"/>
            <slot name="having"/>
        </sql>
        <results module="graphtool.database.query_handler" function="simple_results_parser">
            <inputs>
                <input name="pivots"> 0 </input>
                <input name="results"> 1 </input>
            </inputs>
        </results>
        <attribute name="graph_type">GratiaPie</attribute>
        <attribute name="pivot_name" />
        <attribute name="title" />
        <attribute name="column_names" />
        <attribute name="column_units" />
    </query>

    <query name="glidein_master_summary">
        <inputs>
            <input name="span" type="int" kind="sql">86400</input>
            <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
            <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
            <input name="includeFailed" kind="sql"> true </input>
            <input name="includeSuccess" kind="sql"> true </input>
            <input name="facility" kind="sql"> .* </input>
            <input name="probe" kind="sql"> .* </input>
            <input name="user" kind="sql"> .* </input>
            <input name="vo" kind="sql"> .* </input>
            <input name="role" kind="sql"> .* </input>
            <input name="exclude-role" kind="sql"> NONE </input>
            <input name="exclude-vo" kind="sql"> unknown|other </input>
            <input name="exclude-user" kind="sql"> NONE </input>
            <input name="exclude-facility" kind="sql"> NONE  </input>
            <input name="resource-type" kind="sql"> BatchPilot </input>
            <input name="grid" kind="sql"> .* </input>
        </inputs>
        <sql>
            SELECT
                <slot name="group"/>,
                truncate( unix_timestamp(EndTime) / :span, 0 ) * :span as time,
                <slot name="column"/>
            FROM
                MasterSummaryData R
            JOIN
                Probe P on R.ProbeName = P.probename
            JOIN
                Site S on S.siteid = P.siteid
            JOIN
                VONameCorrection VC ON (VC.corrid=R.VOcorrid)
            JOIN
                VO on (VC.void = VO.void)
            <slot name="join"/> 
            WHERE
                R.EndTime &gt;= :starttime AND
                R.EndTime &lt; :endtime AND
                R.HostDescription regexp :facility AND
                R.Grid regexp :grid AND
                VO.VOName regexp :vo AND
                VC.VOName regexp :role AND
                (NOT (VC.VOName regexp :exclude-role)) AND
                (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
                R.CommonName regexp :user AND
                (:includeFailed='true' OR ApplicationExitCode=0) AND
                (:includeSuccess ='true' OR ApplicationExitCode!=0) AND
                (NOT (S.SiteName regexp :exclude-facility)) AND
                (NOT (R.CommonName regexp :exclude-user)) AND
                (NOT (VO.VOName regexp :exclude-vo)) AND
                R.WallDuration &lt; 1100000000 AND
                R.ProbeName regexp :probe
                <slot name="where"/>
            GROUP BY 
                <slot name="group"/>,
                time
            <slot name="having"/>
        </sql>
        <results module="graphtool.database.query_handler" function="results_parser">
            <inputs>
                <input name="pivots"> 0 </input>
                <input name="grouping"> 1 </input>
                <input name="results"> 2 </input>
            </inputs>
        </results>
        <attribute name="graph_type">GratiaStackedBar</attribute>
        <attribute name="pivot_name" />
        <attribute name="title" />
        <attribute name="column_names" />
        <attribute name="column_units" />
    </query>

    <query name="master_summary">
        <inputs>
            <input name="span" type="int" kind="sql">86400</input>
            <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
            <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
            <input name="includeFailed" kind="sql"> true </input>
            <input name="includeSuccess" kind="sql"> true </input>
            <input name="facility" kind="sql"> .* </input>
            <input name="probe" kind="sql"> .* </input>
            <input name="user" kind="sql"> .* </input>
            <input name="vo" kind="sql"> .* </input>
            <input name="role" kind="sql"> .* </input>
            <input name="exclude-role" kind="sql"> NONE </input>
            <input name="exclude-vo" kind="sql"> unknown|other </input>
            <input name="exclude-user" kind="sql"> NONE </input>
            <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
            <input name="resource-type" kind="sql"> ^Batch$ </input>
        </inputs>
        <sql>
            SELECT
                <slot name="group"/>,
                truncate( unix_timestamp(EndTime) / :span, 0 ) * :span as time,
                <slot name="column"/>
            FROM
                MasterSummaryData R
            JOIN
                Probe P on R.ProbeName = P.probename
            JOIN
                Site S on S.siteid = P.siteid
            JOIN
                VONameCorrection VC ON (VC.corrid=R.VOcorrid)
            JOIN
                VO on (VC.void = VO.void)
            <slot name="join"/> 
            WHERE
                R.EndTime &gt;= :starttime AND
                R.EndTime &lt; :endtime AND
                S.SiteName regexp :facility AND
                VO.VOName regexp :vo AND
                VC.VOName regexp :role AND
                (NOT (VC.VOName regexp :exclude-role)) AND
                (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
                R.CommonName regexp :user AND
                (:includeFailed='true' OR ApplicationExitCode=0) AND
                (:includeSuccess ='true' OR ApplicationExitCode!=0) AND
                (NOT (S.SiteName regexp :exclude-facility)) AND
                (NOT (R.CommonName regexp :exclude-user)) AND
                (NOT (VO.VOName regexp :exclude-vo)) AND
                R.WallDuration &lt; 1100000000 AND
                R.ProbeName regexp :probe
                <slot name="where"/>
            GROUP BY 
                <slot name="group"/>,
                time
            <slot name="having"/>
        </sql>
        <results module="graphtool.database.query_handler" function="results_parser">
            <inputs>
                <input name="pivots"> 0 </input>
                <input name="grouping"> 1 </input>
                <input name="results"> 2 </input>
            </inputs>
        </results>
        <attribute name="graph_type">GratiaStackedBar</attribute>
        <attribute name="pivot_name" />
        <attribute name="title" />
        <attribute name="column_names" />
        <attribute name="column_units" />
    </query>

    <query name="monthly_master_summary">
        <inputs>
            <input name="span" type="eval" kind="sql">28*86400</input>
            <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-12*31*86400</input>
            <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
            <input name="includeFailed" kind="sql"> true </input>
            <input name="includeSuccess" kind="sql"> true </input>
            <input name="facility" kind="sql"> .* </input>
            <input name="probe" kind="sql"> .* </input>
            <input name="vo" kind="sql"> .* </input>
            <input name="role" kind="sql"> .* </input>
            <input name="exclude-role" kind="sql"> NONE </input>
            <input name="exclude-vo" kind="sql"> unknown|other </input>
            <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
            <input name="exclude-user" kind="sql"> NONE </input>
            <input name="resource-type" kind="sql"> ^Batch$ </input>
        </inputs>
        <sql>
            SELECT
                <slot name="group"/>,
                unix_timestamp(date_format(EndTime, "%%Y-%%m-01 00:00:00")) as time,
                <slot name="column"/>
            FROM
                MasterSummaryData R
            JOIN
                Probe P on R.ProbeName = P.probename
            JOIN
                Site S on S.siteid = P.siteid
            JOIN
                VONameCorrection VC ON (VC.corrid=R.VOcorrid)
            JOIN
                VO on (VC.void = VO.void)
            <slot name="join"/> 
            WHERE
                R.EndTime &gt;= :starttime AND
                R.EndTime &lt; :endtime AND
                S.SiteName regexp :facility AND
                VO.VOName regexp :vo AND
                VC.VOName regexp :role AND
                (NOT (VC.VOName regexp :exclude-role)) AND
                (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
                (:includeFailed='true' OR ApplicationExitCode=0) AND
                (:includeSuccess ='true' OR ApplicationExitCode!=0) AND
                (NOT (S.SiteName regexp :exclude-facility)) AND
                (NOT (R.CommonName regexp :exclude-user)) AND
                (NOT (VO.VOName regexp :exclude-vo)) AND
                R.WallDuration &lt; 1100000000 AND
                R.ProbeName regexp :probe
                <slot name="where"/>
            GROUP BY 
                <slot name="group"/>,
                time
            <slot name="having"/>
        </sql>
        <results module="graphtool.database.query_handler" function="results_parser">
            <inputs>
                <input name="pivots"> 0 </input>
                <input name="grouping"> 1 </input>
                <input name="results"> 2 </input>
            </inputs>
        </results>
        <attribute name="graph_type">GratiaStackedBar</attribute>
        <attribute name="pivot_name" />
        <attribute name="grouping_name">Time</attribute>
        <attribute name="title" />
        <attribute name="column_names" />
        <attribute name="column_units" />
    </query>

    <query name="simple_summary">
        <inputs>
            <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
            <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
            <input name="facility" kind="sql"> .* </input>
            <input name="probe" kind="sql"> .* </input>
            <input name="vo" kind="sql"> .* </input>
            <input name="exclude-vo" kind="sql"> unknown|other </input>
            <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
            <input name="resource-type" kind="sql"> ^Batch$ </input>
        </inputs>
        <sql>
            SELECT
                <slot name="group"/>,
                <slot name="column"/>
            FROM
                MasterSummaryData R
            JOIN
                Probe P on R.ProbeName = P.probename
            JOIN
                Site S on S.siteid = P.siteid
            JOIN
                VONameCorrection VC ON (VC.corrid=R.VOcorrid)
            JOIN
                VO on (VC.void = VO.void)
            <slot name="join"/>
            WHERE
                R.EndTime &gt;= :starttime AND
                R.EndTime &lt; :endtime AND
                S.SiteName regexp :facility AND
                VO.VOName regexp :vo AND
                (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
                (NOT (S.SiteName regexp :exclude-facility)) AND
                (NOT (VO.VOName regexp :exclude-vo)) AND
                R.WallDuration &lt; 1100000000 AND
                R.ProbeName regexp :probe
                <slot name="where"/>
            GROUP BY 
                <slot name="group"/>
            <slot name="having"/>
        </sql>
        <results module="graphtool.database.query_handler" function="simple_results_parser">
            <inputs>
                <input name="pivots"> 0 </input>
                <input name="results"> 1 </input>
            </inputs>
        </results>
        <attribute name="graph_type">GratiaPie</attribute> 
        <attribute name="pivot_name" />
        <attribute name="title" />
        <attribute name="column_names" />
        <attribute name="column_units" />
    </query>

    <query name="jobs_query">
      <inputs>
        <input name="span" type="int" kind="sql">3600</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-2*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input> 
        <input name="user" kind="sql"> .* </input> 
      </inputs>
      <sql>
        SELECT
          <slot name="group"/>,
          truncate( unix_timestamp(EndTime) / :span, 0 ) * :span as time,
          <slot name="column"/>
        FROM
          JobUsageRecord J
        JOIN
          JobUsageRecord_Meta M ON M.dbid = J.dbid
        JOIN
          VONameCorrection V ON J.VOName = V.VOName AND J.ReportableVOName = V.ReportableVOName
        JOIN
          VO ON V.void = VO.void
        JOIN
          Probe P ON M.ProbeName = P.ProbeName
        JOIN
          Site S ON P.siteid = S.siteid 
        <slot name="JOIN"/>
        WHERE
          EndTime &gt;= :starttime AND
          EndTime &lt; :endtime AND
          S.SiteName regexp :facility AND
          VO.VOName regexp :vo AND
          (NOT (S.SiteName regexp :exclude-facility)) AND
          (NOT (VO.VOName regexp :exclude-vo)) AND
          (:user='.*' OR J.KeyInfoContent regexp :user)
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>,
          time
      </sql>
      <results module="graphtool.database.query_handler" function="results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="grouping"> 1 </input>
          <input name="results"> 2 </input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="pivot_name" />
      <attribute name="grouping_name">Time</attribute>
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="jobs_master_summary_query">
      <inputs>
        <input name="span" type="int" kind="sql">86400</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="includeFailed" kind="sql"> true </input>
            <input name="includeSuccess" kind="sql"> true </input>
        <input name="facility" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="role" kind="sql"> .* </input>
         <input name="exclude-role" kind="sql"> NONE </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
        <input name="probe" kind="sql"> .* </input>
        <input name="resource-type" kind="sql"> ^Batch$ </input>
      </inputs>
      <sql>
       SELECT
          <slot name="group"/>,
          truncate( unix_timestamp(EndTime) / :span, 0 ) * :span as time,
          <slot name="column"/>
        FROM
          MasterSummaryData R
        JOIN
          Probe P on R.ProbeName = P.probename
        JOIN
          Site S on S.siteid = P.siteid
        JOIN
          VONameCorrection VC ON (VC.corrid=R.VOcorrid)
        JOIN
          VO on (VC.void = VO.void)
        <slot name="JOIN"/>
        WHERE
          (R.ResourceType regexp :resource-type or R.ResourceType = '') AND 
          EndTime &gt;= :starttime AND
          EndTime &lt; :endtime AND
          S.SiteName regexp :facility AND
          VO.VOName regexp :vo AND
          VC.VOName regexp :role AND
          (NOT (VC.VOName regexp :exclude-role)) AND
          (:includeFailed='true' OR ApplicationExitCode=0) AND
          (:includeSuccess ='true' OR ApplicationExitCode!=0) AND
          (NOT (S.SiteName regexp :exclude-facility)) AND
          (NOT (VO.VOName regexp :exclude-vo)) AND
          R.ProbeName regexp :probe AND
          WallDuration &lt; 1100000000
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>,
          time
      </sql>
      <results module="graphtool.database.query_handler" function="results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="grouping"> 1 </input>
          <input name="results"> 2 </input>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="pivot_name" />
      <attribute name="grouping_name">Time</attribute>
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="jobs_summary_query">
      <inputs>
        <input name="span" type="int" kind="sql">86400</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="user" kind="sql"> .* </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
        <input name="exclude-user" kind="sql"> NONE </input>
        <input name="probe" kind="sql"> .* </input>
        <input name="resource-type" kind="sql"> ^Batch$ </input>
      </inputs>
      <sql>
       SELECT
          <slot name="group"/>,
          truncate( unix_timestamp(EndTime) / :span, 0 ) * :span as time,
          <slot name="column"/>
        FROM
          MasterSummaryData R
        JOIN
          Probe P on R.ProbeName = P.probename
        JOIN
          Site S on S.siteid = P.siteid
        JOIN
          VONameCorrection VC ON (VC.corrid=R.VOcorrid)
        JOIN
          VO on (VC.void = VO.void)
        <slot name="JOIN"/>
        WHERE
          (R.ResourceType regexp :resource-type or R.ResourceType = '') AND
          EndTime &gt;= :starttime AND
          EndTime &lt; :endtime AND
          S.SiteName regexp :facility AND
          VO.VOName regexp :vo AND
          R.CommonName regexp :user AND
          (NOT (S.SiteName regexp :exclude-facility)) AND
          (NOT (R.CommonName regexp :exclude-user)) AND
          (NOT (VO.VOName regexp :exclude-vo)) AND
          R.ProbeName regexp :probe AND
          WallDuration &lt; 1100000000
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>,
          time
      </sql>
      <results module="graphtool.database.query_handler" function="results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="grouping"> 1 </input>
          <input name="results"> 2 </input>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="pivot_name" />
      <attribute name="grouping_name">Time</attribute>
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

  </class>

  <class type="SqlQueries" name="GratiaStorageQuery">

    <attribute name="connection_manager"> GratiaConnMan </attribute>

    <aggregate>
      <connection> gratia </connection>
    </aggregate>

    <query name="simple_query">
      <inputs>
        <input name="span" type="int" kind="sql">86400</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-2*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="protocol" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
      </inputs>
      <sql>
        SELECT
          <slot name="group"/>,
          <slot name="column"/>
        FROM
          MasterTransferSummary R FORCE INDEX (index01)
        JOIN
          Probe P on R.ProbeName = P.probename
        JOIN
          Site S on S.siteid = P.siteid
        JOIN
          VONameCorrection VC ON (VC.corrid=R.VOcorrid)
        JOIN
          VO on (VC.void = VO.void)
        <slot name="JOIN"/>
        WHERE
          StartTime &gt;= :starttime AND
          StartTime &lt; :endtime AND
          VO.VOName regexp :vo AND
          S.SiteName regexp :facility AND
          R.Protocol regexp :protocol AND
          (NOT (S.SiteName regexp :exclude-facility)) AND
          (NOT (VO.VOName regexp :exclude-vo))
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>
        <slot name="having"/> 
      </sql>
      <results module="graphtool.database.query_handler" function="simple_results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="results"> 1 </input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaPie</attribute>
      <attribute name="pivot_name" />
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="summary"> <!-- TRACE This is the base query for facility_transfer_volume -->
      <inputs>
        <input name="span" type="int" kind="sql">86400</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="protocol" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="exclude-facility" kind="sql"> NONE|Generic|Obsolete </input>
      </inputs>
      <sql>
       SELECT
          <slot name="group"/>,
          truncate( unix_timestamp(StartTime) / :span, 0 ) * :span as time,
          <slot name="column"/>
        FROM
          MasterTransferSummary R FORCE INDEX (index01)
        JOIN
          Probe P on R.ProbeName = P.probename
        JOIN
          Site S on S.siteid = P.siteid
        JOIN
          VONameCorrection VC ON (VC.corrid=R.VOcorrid)
        JOIN
          VO on (VC.void = VO.void)
        <slot name="JOIN"/>
        WHERE
          StartTime &gt;= :starttime AND
          StartTime &lt; :endtime AND
          SiteName regexp :facility AND
          R.Protocol regexp :protocol AND
          VO.VOName regexp :vo AND
          (NOT (S.SiteName regexp :exclude-facility)) AND
          (NOT (VO.VOName regexp :exclude-vo))
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>,
          time
      </sql>
      <results module="graphtool.database.query_handler" function="results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="grouping"> 1 </input>
          <input name="results"> 2 </input>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="pivot_name" />
      <attribute name="grouping_name">Time</attribute>
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="site_simple">
      <inputs>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> Unknown </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="user" kind="sql"> .* </input>
        <input name="exclude-dn" kind="sql"> NONE </input>
        <input name="limit" type="int" kind="sql"> 20 </input>
        <input name="offset" type="int" kind="sql"> 0 </input>
      </inputs>
      <sql>
       SELECT
          <slot name="column"/>
        FROM
          MasterTransferSummary R FORCE INDEX (index01)
        JOIN
          Probe P on R.ProbeName = P.probename
        JOIN
          Site S on S.siteid = P.siteid
        JOIN
          VONameCorrection VC ON (VC.corrid=R.VOcorrid)
        JOIN
          VO on (VC.void = VO.void)
        <slot name="JOIN"/>
        WHERE
          StartTime &gt;= :starttime AND
          StartTime &lt; :endtime AND
          S.SiteName=:facility AND
          VO.VOName regexp :vo AND
          (NOT (VO.VOName regexp :exclude-vo)) AND
          CommonName regexp :user AND
          (NOT (CommonName regexp :exclude-dn))
          <slot name="where"/>
        LIMIT :limit OFFSET :offset
      </sql>
      <results module="gratia.database.query_handler" function="table_parser" />
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="site_summary">
      <inputs>
        <input name="span" type="int" kind="sql">3600</input>
        <input name="starttime" partial="down" type="datetime" kind="sql">time.time()-13*86400</input>
        <input name="endtime" partial="up" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> Unknown </input>
        <input name="vo" kind="sql"> .* </input>
        <input name="exclude-vo" kind="sql"> unknown|other </input>
        <input name="user" kind="sql"> .* </input>
      </inputs>
      <sql>
       SELECT
          <slot name="group"/>,
          truncate( unix_timestamp(StartTime) / :span, 0 ) * :span as time,
          <slot name="column"/>
        FROM
          MasterTransferSummary R FORCE INDEX (index01)
        JOIN
          Probe P on R.ProbeName = P.probename
        JOIN
          Site S on S.siteid = P.siteid
        JOIN
          VONameCorrection VC ON (VC.corrid=R.VOcorrid)
        JOIN
          VO on (VC.void = VO.void)
        <slot name="JOIN"/>
        WHERE
          StartTime &gt;= :starttime AND
          StartTime &lt; :endtime AND 
          S.SiteName=:facility AND
          VO.VOName regexp :vo AND
          (NOT (VO.VOName regexp :exclude-vo)) AND
          CommonName regexp :user
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>,
          time
      </sql>
      <results module="graphtool.database.query_handler" function="results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="grouping"> 1 </input>
          <input name="results"> 2 </input>
          <input name="grouping_transform">make_int</input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="pivot_name" />
      <attribute name="grouping_name">Time</attribute>
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

  </class>

</graphtool-config>


