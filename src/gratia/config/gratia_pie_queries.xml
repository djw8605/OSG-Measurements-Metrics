<graphtool-config>

  <import module="gratia.config" data_file="generic_queries.xml" />

  <class type="SqlQueries" name="GratiaPieQueries">

    <attribute name="connection_manager"> GratiaConnMan </attribute>

    <attribute name="display_name"> Pie Chart </attribute>

<!--
    <query name="facility_hours" base="GratiaGenericQuery.simple_query">
      <inputs>
        <input kind="sql" type="float" name="min_hours"> 10 </input>
      </inputs>
      <sql>
        <filler name="group"> CETable.facility_name </filler>
        <filler name="column"> sum(WallDuration)/3600 as WallHours </filler>
        <filler name="having"> HAVING sum(WallDuration)/3600 >= :min_hours </filler>
      </sql>
      <attribute name="pivot_name"> Facility </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="title"> Computational Hours by Site </attribute>
    </query>

    <query name="vo_hours" base="GratiaGenericQuery.simple_query">
      <inputs>
        <input kind="sql" type="float" name="min_hours"> 10 </input>
      </inputs>
      <sql>
        <filler name="group"> VOName </filler>
        <filler name="column"> sum(WallDuration)/3600 as WallHours </filler>
        <filler name="having"> HAVING sum(WallDuration)/3600 >= :min_hours </filler>
      </sql>
      <attribute name="pivot_name"> VO </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="title"> Computational Hours by VO </attribute>
    </query>
-->

    <query name="osg_vo_hours" base="GratiaGenericQuery.simple_summary">
        <inputs>
            <input kind="sql" type="float" name="min_hours"> 10 </input>
        </inputs>
      <sql>
        <filler name="group"> R.VOName </filler>
        <filler name="column"> sum(R.WallDuration)/3600 as WallHours </filler>
        <filler name="having"> HAVING sum(R.WallDuration)/3600 >= :min_hours </filler>
      </sql>
      <attribute name="pivot_name"> VO </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="title"> Computational Hours by VO </attribute>
    </query>

    <query name="osg_facility_hours" base="GratiaGenericQuery.simple_summary">
        <inputs>
            <input kind="sql" type="float" name="min_hours"> 10 </input>
        </inputs>
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(R.WallDuration)/3600 as WallHours </filler>
        <filler name="having"> HAVING sum(R.WallDuration)/3600 >= :min_hours </filler>
      </sql>
      <attribute name="pivot_name"> Facility </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="title"> Computational Hours by Facility </attribute>
    </query>

    <query name="osg_facility_cpu_hours" base="GratiaGenericQuery.simple_summary">
        <inputs>
            <input kind="sql" type="float" name="min_hours"> 10 </input>
        </inputs>
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(R.CpuUserDuration + CpuSystemDuration)/3600 as CpuHours </filler>
        <filler name="having"> HAVING CpuHours >= :min_hours </filler>
      </sql>
      <attribute name="pivot_name"> Facility </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="title"> Computational Hours by Facility </attribute>
    </query>

    <query name="osg_probe_hours" base="GratiaGenericQuery.simple_summary">
        <inputs>
            <input kind="sql" type="float" name="min_hours"> 10 </input>
        </inputs>
      <sql>
        <filler name="group"> R.ProbeName </filler>
        <filler name="column"> sum(R.WallDuration)/3600 as WallHours </filler>
        <filler name="having"> HAVING sum(R.WallDuration)/3600 >= :min_hours </filler>
      </sql>
      <attribute name="pivot_name"> Probe </attribute>
      <attribute name="column_names"> Computation Time </attribute>
      <attribute name="column_units"> Hours </attribute>
      <attribute name="title"> Computational Hours by Probe </attribute>
    </query>

    <query name="osg_vo_count" base="GratiaGenericQuery.simple_summary">
      <sql>
        <filler name="group"> R.VOName </filler>
        <filler name="column"> sum(R.Njobs) </filler>
      </sql>
      <attribute name="pivot_name"> VO </attribute>
      <attribute name="column_names"> Jobs </attribute>
      <attribute name="column_units"/>
      <attribute name="title"> Job Count by VO </attribute>
    </query>

    <query name="osg_facility_count" base="GratiaGenericQuery.simple_summary">
      <sql>
        <filler name="group"> S.SiteName </filler>
        <filler name="column"> sum(R.Njobs) </filler>
      </sql>
      <attribute name="pivot_name"> Facility </attribute>
      <attribute name="column_names"> Jobs </attribute>
      <attribute name="column_units"/>
      <attribute name="title"> Job Count by Facility </attribute>
    </query>

    <query name="osg_sharing_sites_pie_perc" base="GratiaGenericQuery.simple_summary">
      <sql>
        <filler name="group"> R.VOName, S.SiteName </filler>
        <filler name="column"> sum(WallDuration)/3600 </filler>
        <filler name="where"> AND WallDuration > 0 </filler>
      </sql>
      <attribute name="pivot_name">Usage Type</attribute>
      <attribute name="title">Percent of Opportunistic CPU Hours</attribute>
      <attribute name="graph_type">GratiaPie</attribute>
      <results module="gratia.database.query_handler" function="opp_usage_simple_perc">
        <inputs>
          <input name="pivots"> 0,1 </input>
          <input name="results"> 2 </input>
        </inputs>
      </results>
    </query>


  </class>

</graphtool-config>
