<graphtool-config>

  <import module="graphtool.database.queries">SqlQueries</import>
  <import module="graphtool.database.query_handler">*</import>
  <import module="time"/> 
  <import file="$HOME/DBParam.xml" />

  <class type="SqlQueries" name="GratiaGenericQuery">

    <attribute name="connection_manager"> GratiaConnMan </attribute>

    <aggregate>
      <connection> gratia </connection>
    </aggregate>

    <query name="simple_query">
      <inputs>
        <input name="span" type="int" kind="sql">3600</input>
        <input name="starttime" type="datetime" kind="sql">time.time()-2*86400</input>
        <input name="endtime" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
      </inputs>
      <sql>
        SELECT
          <slot name="group"/>,
          <slot name="column"/>
        FROM
          JobUsageSimple
        JOIN
          CEProbes ON JobUsageSimple.ProbeName = CEProbes.probename
        JOIN
          CETable ON CEProbes.facility_id = CETable.facility_id
        <slot name="JOIN"/>
        WHERE
          EndTime &gt;= :starttime AND
          EndTime &lt; :endtime AND
          CETable.facility_name regexp :facility AND
          VOName regexp :vo
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>
        <slot name="having"/> 
      </sql>
      <results module="graphtool.database.query_handler" function="simple_results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="results"> 1 </input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaPie</attribute>
      <attribute name="pivot_name" />
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

    <query name="jobs_query">
      <inputs>
        <input name="span" type="int" kind="sql">3600</input>
        <input name="starttime" type="datetime" kind="sql">time.time()-2*86400</input>
        <input name="endtime" type="datetime" kind="sql">time.time()</input>
        <input name="facility" kind="sql"> .* </input>
        <input name="vo" kind="sql"> .* </input>
      </inputs>
      <sql>
        SELECT
          <slot name="group"/>,
          truncate( unix_timestamp(EndTime) / :span, 0 ) * :span,
          <slot name="column"/>
        FROM
          JobUsageSimple
        JOIN
          CEProbes ON JobUsageSimple.ProbeName = CEProbes.probename
        JOIN
          CETable ON CEProbes.facility_id = CETable.facility_id
        <slot name="JOIN"/>
        WHERE
          EndTime &gt;= :starttime AND
          EndTime &lt; :endtime AND
          CETable.facility_name regexp :facility AND
          VOName regexp :vo
          <slot name="where"/>
        GROUP BY
          <slot name="group"/>,
          truncate( unix_timestamp(EndTime) / :span, 0 ) * :span
      </sql>
      <results module="graphtool.database.query_handler" function="results_parser">
        <inputs>
          <input name="pivots"> 0 </input>
          <input name="grouping"> 1 </input>
          <input name="results"> 2 </input>
        </inputs>
      </results>
      <attribute name="graph_type">GratiaStackedBar</attribute>
      <attribute name="pivot_name" />
      <attribute name="grouping_name">Time</attribute>
      <attribute name="title" />
      <attribute name="column_names" />
      <attribute name="column_units" />
    </query>

  </class>

</graphtool-config>


